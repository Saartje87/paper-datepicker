<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<!-- <link rel="import" href="../bower_components/iron-icons/iron-icons.html"> -->
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<script src="../bower_components/moment/moment.js"></script>

<link rel="import" href="../paper-datepicker-button.html">

<dom-module id="paper-datepicker-dialog">

    <style>
    * {
        box-sizing: border-box;
    }

    :root {
        --default-primary-color: #009688;
        --default-text-color: white;
        box-sizing: border-box;
    }

    paper-dialog {
        min-width: 300px;
    }

    @media all and (orientation:landscape) {
        paper-dialog {
            @apply(--layout-horizontal);
            min-width: 500px;
        }

        .toolbar {
            width: 170px;
        }
    }

    /* Toolbar */
    .toolbar {
        background-color: var(--default-primary-color);
        color: var(--default-text-color);
        margin-top: 0;
        padding: 24px;
    }

    .toolbar .year-display {
        @apply(--paper-font-subhead);
        overflow: hidden;
        opacity: 0.7;
    }

    .toolbar .date-display {
        @apply(--paper-font-title);
        overflow: hidden;
        opacity: 0.7;
    }

    .toolbar .highlight {
        opacity: 1;
    }

    /* Container */
    .container {
        @apply(--layout-flex);
        @apply(--layout-scroll);
        margin: 0;
    }

    .navigation {
        @apply(--layout-horizontal);
    }

    .header {
        @apply(--layout-horizontal);
    }

    .header div {
        @apply(--layout-flex);
        text-align: center;
        color: #9e9e9e; /* @todo(Saar) Use --foo */
    }

    .row {
        @apply(--layout-horizontal);
        /*@apply(--layout-justified);*/
        height: 36px;
    }

    section .row:first-child {
        @apply(--layout-end-justified);
    }

    paper-datepicker-button {
        @apply(--layout-flex);
        text-align: center;
        max-width: calc(100% / 7);
    }
    </style>

    <template>

        <paper-dialog modal id="dialog">

            <div class="toolbar">
                <!-- @todo(Saar) Could create new elements, wich handles anikmation when text changes -->
                <datepicker-animation class="year-display" label$="[[selectedYear]]"></datepicker-animation>
                <datepicker-animation class="date-display highlight" label$="[[selectedDate]]"></datepicker-animation>
            </div>

            <div class="container">
                <div class="navigation">
                    <paper-icon-button icon="hardware:keyboard-arrow-left" alt="menu" on-tap="_prevMonthAction"></paper-icon-button>
                    <div class="flex">
                        <datepicker-animation label$="[[monthName]]"></datepicker-animation>
                    </div>
                    <paper-icon-button icon="hardware:keyboard-arrow-right" alt="menu" on-tap="_nextMonthAction"></paper-icon-button>
                </div>

                <div class="header">
                    <div>M</div>
                    <div>D</div>
                    <div>W</div>
                    <div>D</div>
                    <div>V</div>
                    <div>Z</div>
                    <div>Z</div>
                </div>

                <section>
                    <template is="dom-repeat" items="{{dates}}">
                        <div class="row">
                            <template is="dom-repeat" items="{{item}}">
                                <paper-datepicker-button value="{{item}}" on-tap="_tapSelectAction"></paper-datepicker-button>
                            </template>
                        </div>
                    </template>
                </section>

                <div class="buttons">
                    <paper-button dialog-dismiss>CANCEL</paper-button>
                    <paper-button on-click="_confirmAction" dialog-confirm autofocus>OK</paper-button>
                </div>
            </div>
        </paper-dialog>
    </template>

    <script>
    Polymer({

        is: "paper-datepicker-dialog",

        properties: {

            firstRender: {
                type: Boolean,
                value: true
            },

            value: {
                type: String,
                value: moment().format('ddd, MMM D'),
                reflectToAttribute: true
            },

            dates: {
                type: Array,
                value: function () {
                    return [];
                }
            },

            date: {
                type: Date,
                value: function () {
                    return new Date();
                },
                observer: '_createDates'
            },

            selectedYear: {
                type: String,
                // observer: '_getYear(date)'
            },

            selectedDate: {
                type: String
            },

            monthName: {
                type: String
            }

            // locale
            // minDate, maxDate
        },

        behaviors: [
            Polymer.IronA11yKeysBehavior
        ],

        keyBindings: {
            'left right down up': '_pressedAction'
        },

        _pressedAction: function ( event ) {

            var combo = event.detail.combo;

            if( combo === 'left' ) {
                // @todo(Saar) Previous day
                this._prevMonthAction();
            }

            if( combo === 'top' ) {
                // @todo(Saar) Previous week, same day of week
                // this._prevMonthAction();
            }

            if( combo === 'right' ) {
                // @todo(Saar) Next day
                this._nextMonthAction();
            }

            if( combo === 'bottom' ) {
                // @todo(Saar) Next week, same day of week
                // this._prevMonthAction();
            }
        },

        _tapSelectAction: function ( event ) {

            var target = Polymer.dom(event).localTarget;

            this._select(target.value);
        },

        _select: function () {

            // node.value
            var target = Polymer.dom(this).querySelector('[value="2015-08-13"]');

            console.log(target);
        },

        ready: function () {

            // @todo(Saar) Should handle this on select
            this.selectedYear = this.date.getFullYear();
            this.selectedDate = moment(this.date).format('ddd, MMM D');
        },

        open: function () {

            this.$.dialog.open();
        },

        close: function () {

            this.$.dialog.close();
        },

        _keyAction: function ( event ) {
            console.log(event);
        },

        _confirmAction: function () {

            console.log('Confirm');
        },

        _prevMonthAction: function () {

            this.date.setMonth(this.date.getMonth() - 1);

            this._createDates();
        },

        _nextMonthAction: function () {

            this.date.setMonth(this.date.getMonth() + 1);

            this._createDates();
        },

        _getYear: function () {

            console.log(this.date.getFullYear());

            return this.date.getFullYear();
        },

        _createDates: function () {

            if( this.firstRender ) {
                this.firstRender = !this.firstRender;

                this._renderMonth();
            } else {
                window.setTimeout(this._renderMonth.bind(this), 60);
            }
        },

        _renderMonth: function () {

            // @todo(Saar) use moment

            var date = new Date(this.date),
                endDate = new Date(this.date),
                dates = [],
                week;

            this.monthName = moment(date).format('MMMM');
            this.selectedYear = this.date.getFullYear();
            this.selectedDate = moment(this.date).format('ddd, MMM D');

            date.setDate(1);
            endDate.setDate(1);
            endDate.setMonth(endDate.getMonth() + 1);

            if( this.date.getDay() !== 0 ) {
                dates.push([]);
            }

            while( date < endDate ) {

                if( date.getDay() === 1 ) {

                    dates.push([]);
                }

                week = dates[dates.length - 1];

                if( week ) {

                    week.push(new Date(date));
                }

                date.setDate(date.getDate() + 1);
            }

            // 'Hack' to always display 6 rows
            while( dates.length < 6 ) {
                dates.push([]);
            }

            this.dates = dates;
        }
    });
    </script>

</dom-module>
