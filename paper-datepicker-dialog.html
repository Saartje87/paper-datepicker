<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="paper-datepicker-dialog">

    <style>
    :root {
        --default-primary-color: #009688;
        --default-text-color: white;
        box-sizing: border-box;
    }

    paper-dialog {
        width: 400px;
    }

    paper-dialog .header {
        margin-top: 0;
        padding: 24px;
        background-color: var(--default-primary-color);
        color: var(--default-text-color);
    }

    paper-dialog .header span {
        display: block;
        margin: 12px 0;
        opacity: .7;
    }

    paper-dialog .header .highlight {
        opacity: 1;
    }

    paper-dialog .header .year {
        font-size: 1.5em;
    }

    paper-dialog .header .date {
        font-size: 2em;
    }

    paper-dialog .month-container .head {
        @apply(--layout-horizontal);
    }

    paper-dialog .month-container .head span {
        @apply(--layout-flex);
        text-align: center;
        color: #9e9e9e;
    }

    paper-dialog .month-container .container > div {
        @apply(--layout-horizontal);
        @apply(‑‑layout-end-justified);
    }

    paper-dialog .month-container .container > div:first-child {
        @apply(‑‑layout-end-justified);
    }

    paper-dialog .month-container .container paper-button {
        @apply(--layout-flex);
        min-width:  calc(100% / 9);
        max-width: calc(100% / 9);
        border-radius: 50%;
    }

    paper-dialog .month-container .navigation {
        @apply(--layout-horizontal);
        margin-left: 24px;
        margin-right: 24px;
        margin-bottom: 12px;
    }

    paper-dialog .month-container .navigation div:nth-child(2) {
        @apply(--layout-flex);
        text-align: center;
    }
    </style>

    <template>
        <paper-dialog id="dialog">

            <div class="header">
                <span class="year">{{selectedYear}}</span> <!-- Could be a href, click opens year selector -->
                <span class="date highlight">{{selectedDate}}</span>
            </div>

            <div class="month-container">
                <div class="navigation">
                    <div on-click="_prevMonthAction">&lt;</div>
                    <div>{{currentMonth}}</div>
                    <div on-click="_nextMonthAction">&gt;</div>
                </div>
                <div class="head">
                    <span>M</span>
                    <span>D</span>
                    <span>W</span>
                    <span>D</span>
                    <span>V</span>
                    <span>Z</span>
                    <span>Z</span>
                </div>
                <div class="container">
                    <template is="dom-repeat" items="{{dates}}">
                        <div>
                            <template is="dom-repeat" items="{{item}}">
                                <paper-button>{{item.day}}</paper-button>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <div class="buttons">
                <paper-button dialog-dismiss>CANCEL</paper-button>
                <paper-button on-click="_confirmAction" dialog-confirm autofocus>OK</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>
    // element registration
    var MONTH_NAMES = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];

    Polymer({

        is: "paper-datepicker-dialog",

        properties: {

            value: {
                type: String,
                value: (new Date()).toISOString(),
                reflectToAttribute: true
            },

            dates: {
                type: Array,
                value: function () {
                    return [];
                }
            },

            date: {
                type: Date,
                value: function () {
                    return new Date();
                },
                observer: '_createDates'
            },

            selectedYear: {
                type: String,
                // observer: '_getYear(date)'
            },

            selectedDate: {
                type: String
            },

            currentMonth: {
                type: String
            }

            // locale
            // minDate, maxDate
        },

        ready: function () {

            // Ready
            // this.dates = [[{day: 1}], [{day: 1}], [{day: 1}]];

            setTimeout(function () {
                this._createDates();
            }.bind(this), 100);

            // @todo(Saar) Should handle this on select
            this.selectedYear = this.date.getFullYear();
            this.selectedDate = this.date.toDateString().substr(0, 11);
        },

        open: function () {

            this.$.dialog.open();
        },

        close: function () {

            this.$.dialog.close();
        },

        _confirmAction: function () {

            console.log('Confirm');
        },

        _prevMonthAction: function () {

            this.date.setMonth(this.date.getMonth() - 1);

            this._createDates();
        },

        _nextMonthAction: function () {

            this.date.setMonth(this.date.getMonth() + 1);

            this._createDates();
        },

        _getYear: function () {

            console.log(this.date.getFullYear());

            return this.date.getFullYear();
        },

        _createDates: function () {

            //@todo(Saar) always have 6 weeks

            var date = new Date(this.date),
                endDate = new Date(this.date),
                dates = [[]],
                week;

            this.currentMonth = MONTH_NAMES[date.getMonth()];

            date.setDate(1);
            endDate.setDate(1);
            endDate.setMonth(endDate.getMonth() + 1);

            while( date < endDate ) {

                if( date.getDay() === 1 ) {

                    dates.push([]);
                }

                week = dates[dates.length - 1];

                if( week ) {

                    week.push({day: date.getDate()});
                }

                date.setDate(date.getDate() + 1);
            }

            this.dates = dates;
        }
    });
    </script>

</dom-module>
